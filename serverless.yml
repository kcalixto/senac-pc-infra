service: senac-pc

custom:
  vpcID: "vpc-0df351153bc7efddd"
  vpcSubnetID: "subnet-094a3db510feb76f3"

  keyName: senac-ssh-v2

provider:
  name: aws
  runtime: nodejs18.x
  region: sa-east-1
  stage: prd
  environment:
    INSTANCE_ID: "Teste"
    VOLUME_ID: !Ref Volume

resources:
  Resources:
    SecurityGroupSSH:
      Type: AWS::EC2::SecurityGroup
      Properties:
        VpcId: ${self:custom.vpcID}
        GroupDescription: ${self:service}-ssh-sg
        GroupName: ${self:service}-ssh-sg

    SSHOutboundRule:
      Type: AWS::EC2::SecurityGroupEgress
      Properties:
          CidrIp: 186.239.253.173/0

          IpProtocol: tcp
          FromPort: 0
          ToPort: 65535
          GroupId:
            Fn::GetAtt:
              - SecurityGroupSSH
              - GroupId

    SSHInboundRule:
      Type: AWS::EC2::SecurityGroupIngress
      Properties:
          CidrIp: 186.239.253.173/0

          IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          GroupId:
            Fn::GetAtt:
              - SecurityGroupSSH
              - GroupId

    Instance:
      Type: AWS::EC2::Instance
      Properties:
        ImageId: ami-05240a8eacac22db2
        KeyName: ${self:custom.keyName}
        InstanceType: t2.micro

        SubnetId: ${self:custom.vpcSubnetID}
        SecurityGroupIds:
          - !Ref SecurityGroupSSH

        Volumes:
          - Device: /dev/sdf
            VolumeId: !Ref Volume

        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            sudo yum -y update
            sudo yum -y install zsh

            sh -c "$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
            chsh -s /bin/zsh ec2-user
            echo 'export ZSH=/home/ec2-user/.oh-my-zsh' >> /home/ec2-user/.zshrc
            echo 'export TERM=xterm-256color' >> /home/ec2-user/.zshrc
            echo '. $ZSH/oh-my-zsh.sh' >> /home/ec2-user/.zshrc

    Volume:
      Type: AWS::EC2::Volume
      Properties: 
        AvailabilityZone: sa-east-1a
        Size: 8
        VolumeType: gp3